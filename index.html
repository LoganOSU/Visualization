<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Traffic Accident Visualization</title>
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="jRange-master/jquery.range.css">
	<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="jRange-master/jquery.range.js"></script>
		<style type="text/css">
		#floating-panel {

		float: left;
		width: 25%;
		height: 100%; /* only for demonstration, should be removed */
		background:#E6E6FA;
		padding: 20px;
      }
      #map{
      	float: left;
		padding: 20px;
		width: 75%;
		background-color: #f1f1f1;
		height: 500px;		
      }
      #floating-panel-2{/*
		float: left;
		width: 20%;
		height: 500px;  only for demonstration, should be removed 
		background: #ccc;
		padding: 20px;*/
      	
      	position: absolute;
        top: 300px;
        left: 100px;
        width: 500px;
        height: 20px;
        right : 900px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        opacity: 0.7;
      }
      #player{
  	  	text-align: center;
      }
    #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
		#form_path{
			width: 30%;
		}
		.slider{
			position:absolute;
			top:20px;
		}
		.margin{
			padding:10px;
		}
	</style>
	</head>
	<body>

		<nav class="navbar navbar-default" role="navigation">
			<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">Traffic Accident Visualization</a>
			</div>
			</div>
		</nav>
		<div id="floating-panel">
 		 		<legend>Select Hurricane</legend>
						<select id = 'hurricane' class="form-control" onchange = "selectOnchange(this)" >
							<option value = 'julia'>Julia</option>
							<option value = 'Cindy'>Cindy</option>		
							<option value = 'Emily'>Emily</option>
							<option value = 'HERMINE'>Hermine</option>
							<option value = 'Harvey'>Harvey</option>
							<option value = 'irma'>Irma</option>
							<option value = 'mattrew'>Mattrew</option>
							<option value = 'Nate'>Nate</option>
						</select>
 		 		<div class = 'margin'></div>
 		 		<legend>Select Event Type</legend>
 		 			<select id = "type" class="form-control" onchange = "selectOnchange(this)"> 
							<option value = 'All'>All</option>
							<option value = 'Incident/accident'>Accident</option>		
							<option value = 'Construction'>Construction</option>
							<option value = 'Event'>Event</option>
							<option value = 'Congestion/Flow'>Congestion</option>
					</select>
 		 		<div class = 'margin'></div>				
 		 		<legend>Select Speed</legend>
 		 			<select id = "speed" class="form-control"> 
							<option value = 500>slow</option>
							<option value = 200>medium</option>		
							<option value = 100>fast</option>
					</select>
 		 		<div class = 'margin'></div>						

 		 		<legend>Select Time</legend>
 		 		<input type="hidden" class = "slider" id="age-slider"  />
 		 		<div class = 'margin'></div>
 		 			<p>From <span id = 'starttime'></span> to <span id = 'endtime'></span><p>
 		 			<div id = 'player'><button class="btn btn-primary btn-lg" type="button" onclick = "play()"  class="btn btn-primary btn-sm">Play</button>
					<button class="btn btn-primary btn-lg" type="button" onclick = "stop()"  class="btn btn-primary btn-sm">Stop</button>
 		 			</div>
 		 		<p> <b>Current time: </b> <span id = 'currenttime'></span><p>

					
    	</div>
		<div id="map"></div>
		<script type="text/javascript">
			function transfer(time){
				console.log(time);
					[a, b, c, d] = time;
					// console.log(a);
					return b + '/' + c + '/' + a + ' ' + d +':00';
				}
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
			var deltalat, deltalng, position;
			var current, target, count, delay;
 			var map, heatmap, current_heatmap, marker;
 			var flag = 0;
 			function stop(){
 				flag = 1;
 			}
	        function hurricane_change(){
	        	if(flag == 1||current == target - 1){
	        		flag = 0;
	        		return;}
	        	console.log(position[current]);	
        		marker.set('position',new google.maps.LatLng({lat:position[current][0], lng: position[current][1]}));
				document.getElementById("currenttime").innerHTML = transfer(time[current]);
				pre = current_heatmap;
			  	current_heatmap = heatmap[current];
			  	current_heatmap.setMap(map);
			  	pre.setMap(null);
				current += 1;
			  	setTimeout(hurricane_change, delay);
	        }
	        function play(){
        		temp = $('.slider').val().split(',');
        		console.log(temp);
        		left = parseInt(temp[0]);
        		right = parseInt(temp[1]);
        		delay = parseInt($('#speed').val());
        		console.log(delay);

				current_heatmap.setMap(null);
				 current_heatmap = heatmap[left];
				 current_heatmap.setMap(map);		
				// pre = left;
				current = left;
				target = right;
				hurricane_change();
        		
        	}
			function clearOverlay(){
				if(current_heatmap != null){
				current_heatmap.setMap(null);
				marker.set('map',null);
				}

			}
		        var rcd = [], path = [], intensity = [];
		        	heatmap = [];
		        	time = [];
			function selectOnchange(){
		       	clearOverlay();
				$.getJSON("data.json", function(json){
					// json = json;
					// console.log(json);
					rcd = [], intensity = [];
		        	heatmap = [];
		        	time = [];
		        	position = [];
		        	console.log($('#type').val(),$('#hurricane').val());
		        	console.log(json[$('#type').val()]);
					data = json[$('#type').val()][$('#hurricane').val()];
		        	for (var i = 0; i < data.length; i++) {
		        		time.push(data[i].time);
          				position.push(data[i].location);
          				points = [];
          				data[i].points.forEach(foreach);
          				function foreach(item,index){
          					points.push(new google.maps.LatLng(item[0], item[1]));
          				}
          				// position.push(data[i].)
          				heatmap.push(
          					new google.maps.visualization.HeatmapLayer({
							data : points,
							map : null,
							gradient: gradient
						})
          					);
					};
					var symbol = {path: google.maps.SymbolPath.CIRCLE,
				            	scale: 8,
				          		strokeColor: '#393'
        					};
        			// position = data.location;

        			marker = new google.maps.Marker({
					    position: new google.maps.LatLng({lat: position[0][0], lng: position[0][1]}),
					    icon: 'image/ex_nhemi.png',
					    draggable: true,
					    map: map
					  });
        			names = [ 'image/ex_nhemi.png','image/ex_nhemi.png','image/td_nhemi.png','image/ts_nhemi.png']
        			var temp = {path: google.maps.SymbolPath.CIRCLE,
				            	scale: 5,
				          		strokeColor: '#FFF'
        					};
        			$('.slider').jRange('updateRange', '0,' + (time.length - 1));
        			$('.slider').jRange('setValue', '0, '+(time.length - 1));

						var output = document.getElementById("demo");
						current_heatmap = heatmap[0];
						current_heatmap.setMap(map);
						
		    	});
			}
	        function initMap() {
		        map = new google.maps.Map(document.getElementById('map'), {
	          		zoom: 4,
	          		center: {lat: 30, lng: -90},
	          		mapTypeId: 'satellite'
		        });
	        	selectOnchange();
        			$('.slider').jRange({
	                from: 0,
	                to: time.length - 1,
	                step: 1, 
	                width: '100%',
	                format: '%s',
	                showLabels: false,
	                showScale: false,
	                isRange : true,
	                // scale : time,
	                theme: "theme-blue",
	                ondragend: function(){
	                	temp = $('.slider').val().split(',');
        				document.getElementById("starttime").innerHTML = transfer(time[parseInt(temp[0]) - 1]);
        				document.getElementById("endtime").innerHTML = transfer(time[parseInt(temp[1]) - 1]);
        			}
	            });
        			$('.slider').jRange('updateRange', '1,' + time.length, '1,' + time.length);

	        }
		</script>
		<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARIoJbJiEYBSag0ye8-IXQ0LqV61ZpdCg&libraries=visualization&callback=initMap">
    </script>
	</body>
</html>